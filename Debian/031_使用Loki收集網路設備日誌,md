# 使用Loki收集網路設備日誌

### 031_使用Loki收集網路設備日誌,md


本文的主要内容如下：

1. 如何安装部署loki
2. 如何配置网络设备的syslog
3. 如何使用rsyslog收集到网络设备的日志
4. 如何配置Grafana并查看日志



### 环境准备
1台主机，可以是云主机、虚机，可以根据日志的多少来决定配置的大小，本實作中的配置是 8C 16G的

OS为Debian12，但其他发行版如CentOS，大部分情况下也是适用的

該主機将会安装loki，rsyslog、promtail


```
unzip -d /usr/local/bin/ loki-linux-amd64.zip

### 创建用户
useradd -r -s /sbin/nologin loki

### 创建配置文件

mkdir -pv /etc/loki /data/loki

chown -R loki:loki /etc/loki

### 编辑Loki的配置文件


auth_enabled: false

server:
  http_listen_port: 3100
  grpc_listen_port: 9096

common:
  path_prefix: /data/loki
  storage:
    filesystem:
      chunks_directory: /data/loki/chunks
      rules_directory: /data/loki/rules
  replication_factor: 1
  ring:
    instance_addr: 10.20.20.20
    kvstore:
      store: inmemory

schema_config:
  configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

ruler:
  alertmanager_url: http://localhost:9093

请修改以上几项内容

instance_addr，修改为安装主机的IP地址

alertmanager_url：修改为alertmanager的url，本次并未使用alertmanager，所以写的localhost

编辑Systemd[2]的服务配置文件vim /lib/systemd/system/loki.service


```

### 

```

[Unit]
Description=Loki service
After=network.target

[Service]
Type=simple
User=loki
ExecStart=/usr/local/bin/loki-linux-amd64 -config.file /etc/loki/loki-my-config.yaml

[Install]
WantedBy=multi-user.target


### 启动并设置为开机自启动

sudo systemctl daemon-reload

systemctl start loki; systemctl enable loki

systemctl status loki

```

### 設定檔

```
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /etc/promtail/positions.yaml

clients:
# 将地址修改为实际的 loki Server 的地址
  - url: http://localhost:3100/loki/api/v1/push


scrape_configs:
- job_name: loki
  static_configs:
  - targets:
      - localhost
    labels:
      job: syslog
      env: prod
      location: whcq
      vendor: loki
      hostname: m-loki
      __path__: /var/log/network/m-loki-127.0.0.1.log

- job_name: syslog
  static_configs:
  - targets:
      - localhost
    labels:
      job: syslog
      env: prod
      location: whcq   # 设备的机房或者所在的位置
      vendor: huawei   # 品牌
      hostname: Test-S6720-254  # 主机名
      __path__: /var/log/network/Test-S6720-254-10.20.99.254.log  # 日志的路径

- job_name: syslog
  static_configs:
  - targets:
      - localhost
    labels:
      job: syslog
      env: prod
      location: shbd
      vendor: cisco
      hostname: Test-C3560G
      __path__: /var/log/network/192.168.99.254-192.168.99.254.log

```

### 调整promtail执行文件和配置文件的路径

```
mv promtail-linux-amd64 /usr/local/bin/

mkdir -pv /etc/promtail; mv promtail-local-config.yaml config-promtail.yml

```

### 创建用户并修改文件的权限

```
useradd -r promtail

chown promtail:promtail /tmp/positions.yaml

```

### 编辑 Promtail.servicevim /lib/systemd/system/promtail.service

```

[Unit]
Description=Promtail service
After=network.target

[Service]
Type=simple
User=promtail
ExecStart=/usr/local/bin/promtail -config.file /etc/promtail/config-promtail.yml

[Install]
WantedBy=multi-user.target 


```

### 启动服务


```

sudo systemctl daemon-reload

sudo systemctl start promtail

sudo systemctl enable promtail 

```


## 使用rsyslog收集到网络设备的日志

> 搭建并配置rsyslog

##### 配置文件如下vi /etc/rsyslog.conf

```

# provides UDP syslog reception
module(load="imudp")
input(type="imudp" port="514")

# provides TCP syslog reception
module(load="imtcp")
input(type="imtcp" port="514")



$template IpTemplate,"/var/log/network/%HOSTNAME%-%FROMHOST-IP%.log"
*.*  ?IpTemplate
& ~

```

##### %HOSTNAME%-%FROMHOST-IP%.log是日志文件的名字，表示主机名+发送源主机的IP


### 配置Grafana

### 導入 ID为 13639 的Dashboard

配置Variables，建议的配置如下

```

app label_values(job)

env label_values(env)

locaation label_values(location)

vendor label_values(vendor)

hostname label_values({location=~"$location"},hostname)

```
